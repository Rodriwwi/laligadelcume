<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Árbitro - LALIGA DEL CUMe</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Righteous">
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-VZXFXDQZ1C');
    </script>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Righteous', sans-serif;
            margin-top: 100px;
            padding: 20px;
            background: #f0f2f5;
            /* Fondo general un poco más oscuro para contraste */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        h1 {
            text-align: center;
            color: #ef3340;
            margin-bottom: 40px;
            font-size: 2.5rem;
            letter-spacing: 1px;
        }

        /* --- CLASE MAESTRA: TARJETAS DE PASOS (El estilo que te gusta) --- */
        .step-card {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-bottom: 30px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: #d0d0d0;
        }

        .step-header {
            color: #ef3340;
            font-weight: 900;
            font-size: 1.2rem;
            margin-bottom: 20px;
            border-bottom: 2px solid #ef3340;
            padding-bottom: 10px;
            display: inline-block;
            text-transform: uppercase;
        }

        /* --- FORMULARIOS E INPUTS --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
            font-weight: bold;
        }

        /* Estilo unificado para todos los inputs y selects */
        select,
        input[type="text"],
        input[type="time"],
        input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background: #fff;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            box-sizing: border-box;
            /* Importante para que no se salgan */
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            border-color: #ef3340;
            outline: none;
            box-shadow: 0 0 0 3px rgba(239, 51, 64, 0.1);
        }

        /* Layout para inputs en línea (Arbitro, Lugar, Hora) */
        .inline-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* --- BOTONES --- */
        button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.1s;
            text-transform: uppercase;
            font-family: 'Righteous', sans-serif;
        }

        button:active {
            transform: scale(0.98);
        }

        #generarActa {
            background: #2c2c2c;
            /* Negro elegante para generar */
            color: white;
        }

        #generarActa:hover {
            background: #444;
        }

        #btnSubirSupabase {
            background: #ef3340;
            /* Rojo corporativo para subir (acción final) */
            color: white;
            margin-top: 15px;
        }

        #btnSubirSupabase:hover {
            background: #d12a36;
        }

        /* Botón secundario (Ver jugadores) */
        #ver-jugadores-container {
            text-align: center;
            margin-top: 40px;
        }

        #ver-jugadores-btn {
            background: #efa433;
            color: white;
            width: auto;
            padding: 10px 25px;
        }

        #ver-jugadores-btn:hover {
            background: #d99020;
        }

        /* --- EXTRAS --- */
        .loading {
            display: none;
            text-align: center;
            color: #ef3340;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Login Screen */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #10ccb0;
            z-index: 9999;
        }

        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .login-box button {
            background: #ef3340;
            color: white;
            margin-top: 10px;
        }

        /* Estilos de las tarjetas de jugadores (ocultas por defecto) */
        .equipo-card {
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .equipo-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #333;
            color: white;
        }

        .equipo-logo img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
        }

        .jugadores-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
        }

        .jugador-card {
            text-align: center;
            width: 70px;
            font-size: 12px;
        }

        .jugador-card img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
        }

        /* Footer */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-top: 60px;
        }

        .footer-logo img {
            max-width: 180px;
            margin-bottom: 20px;
        }

        /* CORRECCIÓN: Color del nombre de los jugadores */
        .jugador-nombre {
            color: #2c2c2c;
            /* Gris oscuro para que se lea sobre fondo blanco */
            font-weight: bold;
            /* Negrita para que resalte */
            display: block;
            /* Asegura que ocupe su propia línea */
            margin-top: 5px;
            line-height: 1.2;
        }

        /* --- ESTILOS DEL LOGIN (REDISEÑADO) --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 51, 64, 0.95);
            /* Fondo rojo corporativo semitransparente */
            backdrop-filter: blur(5px);
            /* Efecto borroso elegante */
            z-index: 9999;
        }

        .login-box {
            background: #fff;
            padding: 50px 40px;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transform: translateY(0);
            animation: fadeInUps 0.5s ease-out;
        }

        .login-box h2 {
            color: #2c2c2c;
            margin-bottom: 30px;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-box input {
            width: 90%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .login-box input:focus {
            border-color: #ef3340;
            outline: none;
        }

        .login-box button {
            background: #ef3340;
            color: white;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(239, 51, 64, 0.3);
            transition: transform 0.2s, background 0.2s;
        }

        .login-box button:hover {
            background: #d12a36;
            transform: translateY(-2px);
        }

        #error-msg {
            color: #ef3340;
            margin-top: 20px;
            font-weight: bold;
            display: none;
            /* Oculto por defecto */
            background: #ffe6e6;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Pequeña animación de entrada */
        @keyframes fadeInUps {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:#ef3340; margin-bottom:20px;">ACCESO ÁRBITROS</h2>
            <input type="password" id="password" placeholder="Contraseña de acceso">
            <button onclick="checkPassword()">ENTRAR</button>
            <p id="error-msg" style="color:red; display:none; margin-top:10px;">Contraseña incorrecta</p>
        </div>
    </div>

    <div id="content" style="display:none;">

        <nav class="navbar">
            <div class="logoLiga">
                <a href="index.html"> <img src="images/logoLigaRojo.png" alt="CECUME logo" class="img"> </a>
            </div>
        </nav>

        <div class="container">
            <h1>PORTAL DEL ÁRBITRO</h1>

            <div class="step-card">
                <div class="step-header">1. DATOS DEL ENCUENTRO</div>

                <div class="form-group">
                    <label>JORNADA</label>
                    <select id="jornadaSelect">
                        <option value="5" selected>Jornada 5</option>
                    </select>
                </div>

                <div class="inline-inputs" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>EQUIPO LOCAL</label>
                        <select id="equipoLocal">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>EQUIPO VISITANTE</label>
                        <select id="equipoVisitante">
                            <option value="">Cargando...</option>
                        </select>
                    </div>
                </div>

                <div class="inline-inputs">
                    <div class="form-group">
                        <label>ÁRBITRO</label>
                        <input type="text" id="arbitro" placeholder="Nombre(s)">
                    </div>
                    <div class="form-group">
                        <label>LUGAR</label>
                        <input type="text" id="lugar" placeholder="Pista / Campo">
                    </div>
                    <div class="form-group">
                        <label>HORA</label>
                        <input type="time" id="hora">
                    </div>
                </div>
            </div>

            <div class="step-card">
                <div class="step-header">2. PLANTILLA DEL ACTA</div>
                <p style="color:#666; margin-bottom:15px; font-size:14px;">
                    Pulsa para descargar el acta del partido y así poder rellenarlo.
                </p>
                <button id="generarActa">DESCARGAR EXCEL</button>
                <div id="loading" class="loading">⏳ Generando archivo...</div>
            </div>

            <div class="step-card">
                <div class="step-header">3. PUBLICAR ACTA</div>
                <p style="color:#666; margin-bottom:15px; font-size:14px;">
                    Sube aquí el acta en formato Excel (.xlsx) una vez rellenada para publicarla en la nube.
                </p>

                <div class="form-group">
                    <label for="archivoActaFinal"
                        style="cursor: pointer; background: white; border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px;">
                        Seleccionar Archivo Excel
                        <input type="file" id="archivoActaFinal" accept=".xlsx"
                            style="display: block; margin: 10px auto;">
                    </label>
                </div>

                <button id="btnSubirSupabase">SUBIR ACTA</button>
                <p id="mensajeSubida" style="text-align:center; margin-top:15px; font-weight:bold; font-size: 1.1rem;">
                </p>
            </div>

            <div id="ver-jugadores-container">
                <button id="ver-jugadores-btn">CONSULTAR JUGADORES</button>
                <div id="jugadores-equipos" style="margin-top:20px;"></div>
            </div>

        </div>
        <footer>
            <div class="footer-logo"><img src="images/logoLigaNuevo.png" alt="Logo Liga"></div>
        </footer>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const PASSWORD = "j5udp";
        function checkPassword() {
            const input = document.getElementById("password").value;
            if (input === PASSWORD) {
                document.getElementById("login-screen").style.display = "none";
                document.getElementById("content").style.display = "block";
            } else {
                document.getElementById("error-msg").style.display = "block";
            }
        }
    </script>

    <script>
        const supabaseUrl = 'https://omuhkqkjwoibsayyvuag.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tdWhrcWtqd29pYnNheXl2dWFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjE0NjMsImV4cCI6MjA4MDIzNzQ2M30.lZgweY5PS3UmF1zJ5ocUuHGmuoyTuVFF_9BS5xw2VXY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const ALIAS_EQUIPOS = {
            "RAYO MARIGUANO": "rayo",
            "UNIÓN DEPORTIVA PORRETA": "udp",
            "ATLÉTICO MORANTE": "morante",
            "CUM CITY": "city",
            "ASTON BIRRA": "aston",
            "I.E. SALA": "iesala",
            "CUM UNITED": "united"
        };

        function obtenerAlias(nombre) {
            return ALIAS_EQUIPOS[nombre] || nombre.toLowerCase().replace(/\s+/g, '').substring(0, 10);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const plantillaPath = "excels/plantilla_Acta.xlsx";
            const equiposPath = "excels/equipos_actas.xlsx";
            let equiposData = {};
            let plantillaWorkbook;

            const generarActaBtn = document.getElementById("generarActa");
            const loadingDiv = document.getElementById("loading");
            const selectLocal = document.getElementById("equipoLocal");
            const selectVisitante = document.getElementById("equipoVisitante");

            const fileInput = document.getElementById('archivoActaFinal');
            const btnSubir = document.getElementById('btnSubirSupabase');
            const msgSubida = document.getElementById('mensajeSubida');

            // 1. Cargar Datos
            try {
                const respEquipos = await fetch(equiposPath);
                const buffEquipos = await respEquipos.arrayBuffer();
                const wbEquipos = XLSX.read(buffEquipos, { type: "array" });
                wbEquipos.SheetNames.forEach(name => {
                    const sheet = wbEquipos.Sheets[name];
                    equiposData[name] = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                });

                const respPlantilla = await fetch(plantillaPath);
                const buffPlantilla = await respPlantilla.arrayBuffer();
                plantillaWorkbook = XLSX.read(buffPlantilla, { type: "array", cellStyles: true });

                selectLocal.innerHTML = '<option value="">Selecciona Local</option>';
                selectVisitante.innerHTML = '<option value="">Selecciona Visitante</option>';
                Object.keys(equiposData).forEach(team => {
                    selectLocal.add(new Option(team, team));
                    selectVisitante.add(new Option(team, team));
                });
            } catch (err) { console.error(err); alert("Error cargando archivos base."); }

            // 2. Generar Acta
            generarActaBtn.addEventListener("click", async () => {
                const local = selectLocal.value;
                const visitante = selectVisitante.value;
                const jornada = document.getElementById("jornadaSelect").value;
                const arbitro = document.getElementById("arbitro").value;
                const hora = document.getElementById("hora").value;
                const lugar = document.getElementById("lugar").value;

                if (!local || !visitante) return alert("Selecciona equipos.");

                generarActaBtn.disabled = true;
                loadingDiv.style.display = 'block';

                try {
                    const idGenerado = `j${jornada}_${obtenerAlias(local)}_${obtenerAlias(visitante)}`;
                    const wbCopy = XLSX.read(XLSX.write(plantillaWorkbook, { type: "array", bookType: "xlsx" }), { type: "array" });
                    const ws = wbCopy.Sheets["ACTA"];
                    const setCell = (c, v) => { if (!ws[c]) ws[c] = { t: 's', v: '' }; ws[c].v = v; };

                    setCell("C2", local); setCell("C3", visitante);
                    setCell("M3", arbitro || ""); setCell("T3", hora || "");
                    if (lugar) setCell("H3", lugar);

                    const jugL = equiposData[local].slice(4, 15);
                    jugL.forEach((row, i) => { setCell(`A${7 + i}`, row[0] || ""); setCell(`B${7 + i}`, row[1] || ""); setCell(`C${7 + i}`, row[1] || ""); });

                    const jugV = equiposData[visitante].slice(4, 15);
                    jugV.forEach((row, i) => { setCell(`L${7 + i}`, row[0] || ""); setCell(`M${7 + i}`, row[1] || ""); setCell(`N${7 + i}`, row[1] || ""); });

                    if (equiposData[local][0]) setCell("E22", equiposData[local][0][0] || "");
                    if (equiposData[visitante][0]) setCell("U22", equiposData[visitante][0][0] || "");

                    XLSX.writeFile(wbCopy, `${idGenerado}.xlsx`);

                } catch (err) { console.error(err); alert("Error generando excel."); }
                finally { generarActaBtn.disabled = false; loadingDiv.style.display = 'none'; }
            });

            // 3. Subir
            btnSubir.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) return alert("Selecciona el archivo Excel.");

                const nombreArchivo = file.name;
                btnSubir.disabled = true;
                msgSubida.textContent = "Subiendo...";
                msgSubida.style.color = "blue";

                try {
                    const { data, error } = await supabase.storage
                        .from('actas')
                        .upload(nombreArchivo, file, { cacheControl: '0', upsert: true });

                    if (error) throw error;

                    msgSubida.textContent = `✅ ¡ACTA "${nombreArchivo}" SUBIDA!`;
                    msgSubida.style.color = "green";
                    fileInput.value = "";

                } catch (err) {
                    console.error(err);
                    msgSubida.textContent = "❌ Error: " + err.message;
                    msgSubida.style.color = "red";
                } finally {
                    btnSubir.disabled = false;
                }
            });

            // Ver Jugadores
            document.getElementById("ver-jugadores-btn").addEventListener("click", () => {
                const container = document.getElementById("jugadores-equipos");
                container.innerHTML = "";
                Object.keys(equiposData).forEach(team => {
                    const eq = equiposData[team];
                    const div = document.createElement("div");
                    div.className = "equipo-card";
                    div.innerHTML = `<div class="equipo-header"><div class="equipo-logo"><img src="${eq[0][0] || ''}"></div><div class="equipo-nombre">${team}</div></div><div class="equipo-detalle" style="display:block;padding:10px;"><div class="jugadores-grid">${eq.slice(4, 15).map(j => `<div class="jugador-card"><img src="${j[2] || ''}"><span class="jugador-nombre">${j[1] || ''}</span></div>`).join('')}</div></div>`;
                    container.appendChild(div);
                });
                container.style.display = container.style.display === "block" ? "none" : "block";
            });
        });
    </script>
</body>

</html>